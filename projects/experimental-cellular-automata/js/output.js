(()=>{"use strict";function t(t){let e=Object.values(t).reduce(((t,e)=>t+e),0),n=Object.values(t).reduce(((t,n,o)=>[...t,n/e+(t[o-1]||0)]),[]);return function(){let e=Math.random(),o=n.findIndex((t=>e<t));return Object.keys(t)[o]}}class e{constructor(t,e,n,o,i){this.type=t,this.threshold=e,this.t=n,this.o=o,this.i=i,this.u=function(t,e){return"Cond"==t?function(t){return 0==t}:"Abs"==t?function(t){return t%e==0}:function(t){return!0}}(this.o,this.i),this.l=function(t,e,n){return"Eq"==e?function(e){return e[n]==t}:"Bigger"==e?function(e){return e[n]>t}:void 0}(this.threshold,this.type,this.t)}test(t,e){return this.l(t)}name(){return`${this.type}${this.threshold}${this.o}NT${this.t}`}static h(t){var n=null;t.startsWith("Eq")?(n="Eq",t=str.substr):t.startsWith("Bigger")&&(n="Bigger");var o=t.substring(n.length),i=parseInt(t.substring(0,1));o=o.substring(1),inactivation=null,o.startsWith("Cond")?inactivation="Cond":o.startsWith("Abs")?inactivation="Abs":o.startsWith("None")&&(inactivation="None"),o=o.substring(inactivation.length);var r=parseInt(o.substring(2));return new e(n,i,r,inactivation)}static m(n=null,o=4){const i=["Eq","Bigger"],r=i[Math.floor(Math.random()*i.length)];var a=0;a="Eq"===r?Math.floor(8*Math.random())+1:Math.floor(9*Math.random());const s=["Cond","Abs","None"],u=s[Math.floor(Math.random()*s.length)];null===n&&(n={0:1/8,1:1/8,2:1/8,3:1/8,4:1/8,5:1/8,6:1/8,7:1/8});const c=t(n)();return new e(r,a,c,u,o)}}class n{constructor(){this.M}v(t,e,n){throw new Error("Must override method")}}class o extends n{constructor(){super(),this.M=4}v(t,e,n){var o=t%4;return 1==o||3==o?e=2:2==o?e=0:0==o&&2==n[0]?e=1:0==o&&n[0]>2&&(e=3),e}}class i extends n{constructor(t,e){super(),this.p=e,this.S=t,this.M=this.p}v(t,e,n){e=0;for(let o=0;o<this.S.length;o++)if(this.S[o].test(n,t)){e=(o+1)%this.p;break}return e}k(){return this.S.map((t=>t.name())).join(", ")}static C(t=null,n=null,o=4,r=4){var a=[];null==t&&(t=Math.floor(8*Math.random())+2);for(let i=0;i<t;i++)a.push(e.m(n,o));return console.log("Sampling coloring rule: "+a.map((t=>t.name())).join(", ")),new i(a,r)}static R(t){var n=t.split(", ").map((t=>e.h(t)));return new i(n,nColors)}}class r{N(){throw new Error("Must override method")}F(){return function(t,e,n){e=this.I[0].v(t%this.I[0].M,e,n);var o=this.I[0].M;for(let i=1;i<this.I.length;i++)e+=o*this.I[i].v(Math.floor(t/o)%this.I[i].M,e,n),e%=o*=this.I[i].M;return e%o}}}class a extends r{constructor(t,e){super(),this.A=t,this.G=e,null==e&&(this.G="safe"==t?{0:1/3,1:1/3,2:1/3}:"mix"==t?{0:.25,1:.25,2:.25,3:.05,4:.05,5:.05,6:.05,7:.05}:{0:1/8,1:1/8,2:1/8,3:1/8,4:1/8,5:1/8,6:1/8,7:1/8}),this.X=4,this.I=this.N(),this.v=this.F()}N(){var t=[];return t.push(new o),t.push(i.C(null,this.G)),t}}function s(t,e=!1){(Math.random()<t.Y||e||t.j)&&("VariableGR"==t.T?(t.B=new a("safe"),t.O=new a("safe")):"Variable"==t.T?t.B=new a("safe"):"VariableMix"==t.T?t.B=new a("mix"):"VariableUnsafe"==t.T&&(t.B=new a("general")),t.Y=0),t.Y+=1/t.P**2,t.Y>1&&(t.Y=1),t.j=!1}function u(t){let e={};for(let n in t){let o=Math.floor(3*Math.random())-1,i=t[n]+o;i=Math.max(0,Math.min(255,i)),e[n]=i}return e}function c(t){var e={r:247,g:255,b:28},n={r:13,g:112,b:255},o={r:240,g:239,b:239},i={r:0,g:0,b:0},r={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())},a={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())};"yellow"==t.V?(t.backgroundColor=e,t.q=i,t.H=n,t.L=o):"blue"==t.V?(t.backgroundColor=n,t.q=o,t.H=i,t.L=e):"blue2"==t.V?(t.backgroundColor=n,t.q=e,t.H=i,t.L=o):"grey"==t.V?(t.backgroundColor=o,t.q=i,t.H=n,t.L=e):"grey2"==t.V?(t.backgroundColor=o,t.q=e,t.H=i,t.L=n):"black"==t.V?(t.backgroundColor=i,t.q=n,t.H=e,t.L=o):"black2"==t.V?(t.backgroundColor=i,t.q=n,t.H=o,t.L=e):"blackTrace"==t.V?(t.backgroundColor=i,t.q=o,t.H=i,t.L=o):"blackTrace2"==t.V?(t.backgroundColor=i,t.q=i,t.H=i,t.L=o):"blackTrace3"==t.V?(t.backgroundColor=i,t.q=i,t.H=o,t.L=o):"variable"==t.V&&(t.backgroundColor=i,t.q={r:240,g:240,b:240},t.H=r,t.L=a)}function l(t,e,n,o,i){let r=(e+o+t.U)%t.U,a=(n+i+t.W)%t.W,s=r,u=a;return(r-e-o>0||r-e-o<0)&&(u=(t.W-a-t.$+t.W)%t.W),(a-n-i>0||a-n-i<0)&&(s=(t.U-r-t.D+t.U)%t.U),[s,u]}function h(t,e,n,o,i){let r=(e+o+t.U)%t.U,a=(n+i+t.W)%t.W,s=r,u=a;return(r-e-o>0||r-e-o<0)&&(u=(t.W-a-t.$+t.W)%t.W),a-n-i>0?s=(r+t.D+t.U)%t.U:a-n-i<0&&(s=(r-t.D+t.U)%t.U),[s,u]}function f(t,e,n,o,i){let r=(e+o+t.U)%t.U,a=(n+i+t.W)%t.W,s=r,u=a;return r-e-o>0?u=(a+t.$+t.W)%t.W:r-e-o<0&&(u=(a-t.$+t.W)%t.W),(a-n-i>0||a-n-i<0)&&(s=(t.U-r-t.D+t.U)%t.U),[s,u]}function d(t,e,n,o,i){let r=(e+o+t.U)%t.U,a=(n+i+t.W)%t.W,s=r,u=a;return r-e-o>0?u=(a+t.$+t.W)%t.W:r-e-o<0&&(u=(a-t.$+t.W)%t.W),a-n-i>0?s=(r+t.D+t.U)%t.U:a-n-i<0&&(s=(r-t.D+t.U)%t.U),[s,u]}function m(t){t.J&&t.K?t.Z=l:t.J?t.Z=h:t.K?t.Z=f:t.Z=d}function g(t){s(t,!0)}function M(t,e){if(t._){var n={...t.tt};delete n.et,delete n.S;var o={...n,event:e},i=Object.keys(o).join(",")+"\n";i+=Object.values(o).join(",");var r=new Blob([i],{type:"text/csv"}),a=URL.createObjectURL(r),s=document.createElement("a");s.href=a,s.download="dataAutomata.csv",s.click()}}class v{constructor(t,e){this.width=t,this.height=e,this.data=new Uint8Array(t*e),this.rows=new Array(e)}get(t,e){return this.data[t*this.width+e]}set(t,e,n){this.data[t*this.width+e]=n}}let b={nt:{ot:.1,mask:[[1,1],[1,1]]},it:{ot:1,mask:[[1,0,1],[0,0,0],[1,0,1]]},rt:{ot:40,mask:null}},p=Object.keys(b).map((t=>b[t].mask)),S=t(Object.keys(b).map((t=>b[t].ot)));function w(t,e,n,o,i){for(var r=function(t){var e=Math.exp(-t),n=1,o=0;do{o++,n*=Math.random()}while(n>e);return o-1}(10**t.st),a=0;a<r;a++){e=Math.floor(Math.random()*t.U),n=Math.floor(Math.random()*t.W);k(o,t,p[S()],e,n,i)}return{ut:e,ct:n}}function k(t,e,n,o,i,r){null===n&&(n=function(){let t=Math.floor(10*Math.random())+1,e=Math.floor(10*Math.random())+1,n=[];for(let o=0;o<t;o++){n.push([]);for(let t=0;t<e;t++)n[o].push(Math.floor(4*Math.random()))}return n}());let a=n.length,s=n[0].length;for(let u=0;u<a;u++)for(let c=0;c<s;c++){let l=r(e,o,i,u-Math.floor(a/2),c-Math.floor(s/2));t.set(l[0],l[1],n[u][c])}}function C(t){!function(t){let e=t.lt,n=t.ht;for(var o=0,i=0;i<t.U;i++)for(var r=0;r<t.W;r++){if(0==t.ft.get(i,r))continue;o+=1;var a=Math.floor(t.grid.get(i,r)/t.B.X)%4;let e;if(0==a)e=t.backgroundColor;else if(1==a)e=t.q;else if(2==a)e=t.H;else{if(3!=a)continue;e=t.L}let s=4*(i*t.W+r);n.data[s+0]=e.r,n.data[s+1]=e.g,n.data[s+2]=e.b,n.data[s+3]=255}if(t.dt=.01*o+.99*t.dt,t.dt>.5*t.U*t.W){t.j=!0;var s=t.dt/(t.U*t.W);console.log("Changing rule because suspected oscillation (running proportion of cells changed: "+s.toFixed(1)+")."),t.dt=15,M(t,"oscillation")}t.dt<3&&(t.j=!0,console.log("Changing rule because not enough cells changed ("+t.dt+")."),t.dt=20,M(t,"blackout")),e.putImageData(n,t.gt,t.Mt)}(t),function(t){for(var e=new v(t.W,t.U),n=0;n<t.U;n++)for(var o=0;o<t.W;o++){for(var i=0,r=0,a=0,s=0,u=0,c=0,l=0,h=-1;h<=1;h++)for(var f=-1;f<=1;f++){if(0==h&&0==f)continue;let e=t.Z(t,n,o,h,f),d=e[0],m=e[1];t.grid.get(d,m)%4==1?(i+=1,r+=1):t.grid.get(d,m)%4==2?a+=1:t.grid.get(d,m)%4==3&&(r+=1),0==Math.floor(t.grid.get(d,m)%16/4)?s+=1:1==Math.floor(t.grid.get(d,m)%16/4)?u+=1:2==Math.floor(t.grid.get(d,m)%16/4)?c+=1:3==Math.floor(t.grid.get(d,m)%16/4)&&(l+=1)}let g=t.grid.get(n,o);var d=g,m=[i,r,a,s,u,c,l,u+l];d="VariableGR"!=t.T||0==t.mask.get(n,o)?t.B.v(g,d,m):t.O.v(g,d,m),Math.floor(d/t.B.X)%4!=Math.floor(g/t.B.X)%4?t.ft.set(n,o,1):t.ft.set(n,o,0),e.set(n,o,d)}if(t.vt)var{ut:n,ct:o}=w(t,n,o,e,t.Z);t.grid=e}(t),s(t),t.T.includes("Variable")&&function(t){Math.random()<1e-4&&(t.$=Math.floor(Math.random()*t.W),console.log("Periodicity shift X: "+t.$)),Math.random()<1e-4&&(t.D=Math.floor(Math.random()*t.U),console.log("Periodicity shift Y: "+t.D)),Math.random()<1e-4&&(t.J=!t.J,m(t),console.log("Flip X: "+t.J)),Math.random()<1e-4&&(t.K=!t.K,m(t),console.log("Flip Y: "+t.K))}(t),"variable"==t.V&&function(t){Math.random()<1&&(t.L=u(t.L),t.H=u(t.H))}(t),setTimeout((function(){requestAnimationFrame((()=>C(t)))}),t.timeout)}function R(t,e){return console.log("Attempting to load image"),(n="grLogoLarge.png",console.log("Loading image:",n),new Promise(((t,e)=>{const o=new Image;o.onload=()=>{console.log("Image loaded:",n);const e=document.createElement("canvas");e.width=o.width,e.height=o.height;const i=e.getContext("2d");i.drawImage(o,0,0,o.width,o.height);const r=i.getImageData(0,0,e.width,e.height).data,a=[];for(let t=0;t<o.height;t++){const e=[];for(let n=0;n<o.width;n++){const i=4*(t*o.width+n),a=(r[i]+r[i+1]+r[i+2])/3;e.push(a>128?1:0)}a.push(e)}t(a)},o.onerror=()=>{console.error("Error loading image:",n),e(new Error("Error loading image"))},o.src=n}))).then((e=>{new v(t.W,t.U);const n=new v(t.W,t.U),o=e[0].length/t.W,i=e.length/t.U,r=Math.max(o,i),a=Math.floor((t.W-e[0].length/r)/2),s=Math.floor((t.U-e.length/r)/2);for(let o=0;o<t.U;o++)for(let i=0;i<t.W;i++){if(o<s||(o-s)*r>=e.length){n.set(o,i,1);continue}let t=Math.floor((i-a)*r);0===e[Math.floor((o-s)*r)][t]?n.set(o,i,0):n.set(o,i,1)}t.mask=n})).catch((e=>{console.log("Image loading failed, not using a mask."),console.error("Error loading image:",e),t.mask=new v(t.W,t.U)}));var n}async function N(t,e){return await R(t),function(t,e=64){return Promise.resolve().then((()=>{t.grid=new v(t.W,t.U),t.ft=new v(t.W,t.U);for(var n=0;n<t.U;n++)for(var o=0;o<t.W;o++)if("gr"!=t.bt||1!==t.mask.get(n,o)){for(var i=Math.random(),r=0;r<e;r++)if(i<(r+1)/(e+1)){t.grid.set(n,o,r);break}t.ft.set(n,o,1)}else t.grid.set(n,o,0)}))}(t)}function x(t){document.getElementById("submitButton").addEventListener("click",(function(){var t,e,n,o,i,r,a,s,u,c,l;t=document.getElementById("userGridHeight").value,e=document.getElementById("userGridWidth").value,n=document.getElementById("userTimeout").value,o=document.getElementById("userXShift").value,i=document.getElementById("userYShift").value,r=document.getElementById("userFlipX").checked,a=document.getElementById("userFlipY").checked,s=document.getElementById("userColorPalette").value,u=document.getElementById("randomnessCheckbox").checked,c=document.getElementById("randomnessSlider").value,l=document.getElementById("userRule").value,localStorage.setItem("userGridHeight",t),localStorage.setItem("userGridWidth",e),localStorage.setItem("userTimeout",n),localStorage.setItem("userXShift",o),localStorage.setItem("userYShift",i),localStorage.setItem("userFlipX",r),localStorage.setItem("userFlipY",a),localStorage.setItem("userColorPalette",s),localStorage.setItem("userRandomnessOn",u),localStorage.setItem("userRandomnessAmount",c),localStorage.setItem("userRule",l),location.reload()}))}function F(t){document.getElementById("randomnessSlider").addEventListener("input",(function(){!function(t,e){t.st=e,document.getElementById("randomnessAmountValue").textContent=e}(t,this.value)}))}console.log("Loading main.js");var E=document.getElementById("gameCanvas"),I=E.getContext("2d"),A=192,G=192,X=30,Y=!0,j=-1,y=0,T=0,B=!1,O=!1,P="variable",V="Variable",q="random",H=8,L=new class{constructor(t,e,n=200,o=200,i=20,r=!0,a=-2,s=0,u=0,c=!1,l=!1,h="black2",f="VariableGR",d="random",m=6,g=5e3){this.U=n,this.W=o,this.gt=0,this.Mt=0,this.timeout=i,this.grid=null,this.ft=null,this.ht=null,this.canvas=t,this.lt=e,this.vt=r,this.st=a,this.$=s,this.D=u,this.J=c,this.K=l,this.V=h,this.T=f,this.bt=d,this.St=m,this.wt=null,this.kt=null,this.Z=null,this.mask=null,this.P=g,this.Y=1/this.P,this.canvas.width=this.W,this.canvas.height=this.U,this.ht=e.createImageData(t.width,t.height),this.j=!0,this.dt=0,this._=!1}}(E,I,A,G,X,Y,j,y,T,B,O,P,V,q,H);window.onload=function(){!function(t){document.getElementById("randomnessCheckbox").addEventListener("change",(function(){t.vt=this.checked}))}(L),function(t){document.getElementById("fullscreenButton").addEventListener("click",(function(){t.canvas.requestFullscreen?t.canvas.requestFullscreen():t.canvas.mozRequestFullScreen?t.canvas.mozRequestFullScreen():t.canvas.webkitRequestFullscreen?t.canvas.webkitRequestFullscreen():t.canvas.msRequestFullscreen&&t.canvas.msRequestFullscreen()}))}(L),function(t){t.canvas.addEventListener("mousemove",(function(e){if(e.shiftKey){var n=t.canvas.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top,r=n.width/t.W,a=n.height/t.U,s=Math.floor(o/r),u=Math.floor(i/a);t.grid.set(u,s,1)}}))}(L),function(t){t.canvas.addEventListener("mousedown",(function(e){var n=t.canvas.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top,r=n.width/t.W,a=n.height/t.U,s=Math.floor(o/r),u=Math.floor(i/a);e.shiftKey||e.ctrlKey?e.shiftKey&&!e.ctrlKey?(t.grid.set(u,(s+1)%t.W,1),t.grid.set(u,s,1),t.grid.set((u+1)%t.U,s,1)):!e.shiftKey&&e.ctrlKey?(t.grid.set(u,s,1),t.grid.set((u+1)%t.U,s,1)):e.shiftKey&&e.ctrlKey&&(t.grid.set(u,s,1),t.grid.set(u,(s+1)%t.W,1)):(t.grid.set((u+1)%t.U,(s+1)%t.W,1),t.grid.set((u-1+t.U)%t.U,(s+1)%t.W,1),t.grid.set((u-1+t.U)%t.U,(s-1+t.W)%t.W,1),t.grid.set((u+1)%t.U,(s-1+t.W)%t.W,1))}))}(L),x(),F(L),function(t){document.getElementById("userXShift").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.$=e,m(t)})),document.getElementById("userYShift").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.D=e,m(t)})),document.getElementById("userFlipX").addEventListener("change",(function(){t.J=this.checked,m(t)})),document.getElementById("userFlipY").addEventListener("change",(function(){t.K=this.checked,m(t)}))}(L),function(t){document.getElementById("userTimeout").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.timeout=e}))}(L),function(t){document.getElementById("userColorPalette").addEventListener("change",(function(){t.V=this.value,c(t)}))}(L),function(t){document.getElementById("userRule").addEventListener("change",(async function(){t.T=this.value,g(t)}))}(L),function(t){document.getElementById("changeColoringRule").addEventListener("click",(function(){t.j=!0}))}(L),function(t){document.getElementById("changeColor").addEventListener("click",(function(){c(t)}))}(L),function(t){document.getElementById("saveEventCheckbox").addEventListener("change",(function(){t._=this.checked})),document.getElementById("likeButton").addEventListener("click",(function(){M(t,"like")})),document.getElementById("dislikeButton").addEventListener("click",(function(){M(t,"dislike")}))}(L),function(t){null!==localStorage.getItem("userGridHeight")?(t.U=parseInt(localStorage.getItem("userGridHeight")),t.W=parseInt(localStorage.getItem("userGridWidth")),t.U>1e3&&(t.U=1e3),t.W>1e3&&(t.W=1e3),t.ht=t.lt.createImageData(t.W,t.U),t.timeout=parseInt(localStorage.getItem("userTimeout")),t.$=parseInt(localStorage.getItem("userXShift")),isNaN(t.$)&&(t.$=0),isNaN(t.D)&&(t.D=0),t.D=parseInt(localStorage.getItem("userYShift")),t.J="true"===localStorage.getItem("userFlipX"),t.K="true"===localStorage.getItem("userFlipY"),t.V=localStorage.getItem("userColorPalette"),t.vt="true"===localStorage.getItem("userRandomnessOn"),t.st=parseFloat(localStorage.getItem("userRandomnessAmount")),t.T=localStorage.getItem("userRule"),console.log("Retrieved value from previous session: ...")):console.log("No value in localStorage"),document.getElementById("userGridHeight").value=t.U,document.getElementById("userGridWidth").value=t.W,document.getElementById("userTimeout").value=t.timeout,document.getElementById("userXShift").value=t.$,document.getElementById("userYShift").value=t.D,document.getElementById("userFlipX").checked=t.J,document.getElementById("userFlipY").checked=t.K,document.getElementById("userColorPalette").value=t.V,document.getElementById("randomnessCheckbox").checked=t.vt,document.getElementById("randomnessSlider").value=t.st,document.getElementById("userRule").value=t.T,t.canvas.width=Math.max(t.U,t.W),t.canvas.height=Math.max(t.U,t.W),t.gt=0,t.Mt=0;var e=document.getElementById("gameCanvas");if(t.U>t.W){var n=Math.floor(t.W/t.U*800);e.style.width=n+"px",e.style.height="800px",e.width=n*t.U/800,e.height=t.U}else{var o=Math.floor(t.U/t.W*800);e.style.width="800px",e.style.height=o+"px",e.width=t.W,e.height=o*t.W/800}}(L),c(L),m(L),g(L),N(L).then((()=>{C(L)})).catch((t=>{console.error("Error initialising the grid: ",t)}))}})();
(()=>{"use strict";function e(e){let t=Object.values(e).reduce(((e,t)=>e+t),0),i=Object.values(e).reduce(((e,i,r)=>[...e,i/t+(e[r-1]||0)]),[]);return function(){let t=Math.random(),r=i.findIndex((e=>t<e));return Object.keys(e)[r]}}const t=[44,44];function i(e,t,i,r,o){for(var n=-1;n<=1;n++)for(var l=-1;l<=1;l++){if(0==n&&0==l)continue;o[0]=(Math.abs(n)+Math.abs(l))%2,o[e.time%4+1]=-1==n?1:0,o[(1+e.time)%4+1]=-1==l?1:0,o[(2+e.time)%4+1]=1==n?1:0,o[(3+e.time)%4+1]=1==l?1:0;let d=e.findNeighbour(e,t,i,n,l),s=d[0],h=d[1],g=e.grid.get(s,h),u=g%4,c=Math.floor(g%16/4);if(1==u){r[0][0]+=1;for(var a=0;a<o.length;a++)r[0][4+8*a]+=o[a],r[0][8*(a+1)]+=1-o[a]}else if(2==u){r[0][2]+=1;for(a=0;a<o.length;a++)r[0][4+8*a+2]+=o[a],r[0][8*(a+1)+2]+=1-o[a]}else if(3==u){r[0][3]+=1;for(a=0;a<o.length;a++)r[0][4+8*a+3]+=o[a],r[0][8*(a+1)+3]+=1-o[a]}if(Math.floor(0==c)){r[1][0]+=1;for(a=0;a<o.length;a++)r[1][4+8*a]+=o[a],r[1][8*(a+1)]+=1-o[a]}else if(Math.floor(1==c)){r[1][1]+=1;for(a=0;a<o.length;a++)r[1][4+8*a+1]+=o[a],r[1][8*(a+1)+1]+=1-o[a]}else if(Math.floor(2==c)){r[1][2]+=1;for(a=0;a<o.length;a++)r[1][4+8*a+2]+=o[a],r[1][8*(a+1)+2]+=1-o[a]}else if(Math.floor(3==c)){r[1][3]+=1;for(a=0;a<o.length;a++)r[1][4+8*a+3]+=o[a],r[1][8*(a+1)+3]+=1-o[a]}}r[0][1]=r[0][0]+r[0][3];for(a=0;a<o.length+1;a++)r[0][4*a+1]+=r[0][4*a]+r[0][4*a+3];return r}const r="mix",o="isotropic",n="xcross",l="vcross",a="xvcross",d="directional1",s="directional2",h="directional3",g="directional2b",u="directional",c={[r]:.2,[o]:.4,[n]:.05,[l]:.05,[a]:.05,[d]:.05,[s]:.05,[h]:.05,[g]:.05,[u]:.05};const m="A",f="C",v="E",p="B";class C{constructor(e,t,i,r,o,n=null){this.type=e,this.threshold=t,this.neighbourType=i,this.inactivation=r,this.modulo=o,this.periodicity=n,this.testInactive=function(e,t){return e==f?function(e){return 0==e}:e==m?function(e){return e%t==0}:function(e){return!0}}(this.inactivation,this.modulo),this.testValue=function(e,t,i){return t==v?function(t){return t[i[0]][i[1]]==e}:t==p?function(t){return t[i[0]][i[1]]>e}:void 0}(this.threshold,this.type,this.neighbourType),this.testPeriodicity=function(e){let t;return t=null==e?function(e){return!0}:function(t){return e[t%e.length]},t}(n)}test(e,t,i){var r=this.testPeriodicity(i);return this.testValue(e)&&this.testInactive(t)&&r}name(){var e="";return null!=this.periodicity&&(e=this.periodicity.map((e=>e?"1":"0")).join("")),`${this.type}${this.threshold}${this.inactivation}[${this.neighbourType[0]}|${this.neighbourType[1]}]${e}`}static fromName(e,t=4){var i=null;e.startsWith(v)?i=v:e.startsWith(p)&&(i=p);var r=e.substring(i.length),o=parseInt(r.substring(0,1)),n=null;(r=r.substring(1)).startsWith(f)?n=f:r.startsWith(m)?n=m:r.startsWith("N")&&(n="N");var l=(r=r.substring(n.length)).split("[")[1].split("]")[0].split("|").map(Number),a=null;return(r=r.split("]")[1]).length>0&&(a=r.split("").map((e=>"1"===e))),new C(i,o,l,n,t,a)}static randomSample(i=null,c=4,y=r,b=null){const M=[v,p],S=M[Math.floor(Math.random()*M.length)];var w=0;w=S===p?Math.floor(9*Math.random()):Math.floor(8*Math.random())+1;const I=[f,m,"N"],R=I[Math.floor(Math.random()*I.length)];null===i&&(i={0:2/3,1:1/3});const E=e(i)(),H=function(e,i){var c=i;if(c==r){var m=Math.random();return c=m<.5?o:m<.7?n:m<.9?l:u,Math.floor(Math.random()*t[e])}if(c==o)return Math.floor(4*Math.random());if(c==l)return Math.floor(4*Math.random()+4);if(c==n)return Math.floor(4*Math.random()+8);if(c==a)return Math.floor(8*Math.random()+4);if(c==d)return Math.floor(4*Math.random()+12);if(c==s)return Math.floor(8*Math.random()+12);if(c==h)return Math.floor(12*Math.random()+12);if(c==g){var f=Math.floor(8*Math.random()+12);return f>=16&&(f+=4),f}return c==u?Math.floor(16*Math.random()+12):void 0}(E,y),P=[E,H];if(Math.random()<.5)W=null;else{var W;null==b&&(b=Math.floor(4*Math.random())+2);do{W=new Array(b).fill(0).map((()=>Math.random()<.5))}while(!W.includes(!0))}return new C(S,w,P,R,c,W)}}class y{constructor(){this.nStates}updateRule(e,t,i,r){throw new Error("Must override method")}}class b extends y{constructor(){super(),this.nStates=4}updateRule(e,t,i,r){var o=e%4;return 1==o||3==o?t=2:2==o?t=0:0==o&&2==i[0][0]?t=1:0==o&&i[0][0]>2&&(t=3),t}getName(){return"BB"}}class M extends y{constructor(e,t,i,r,o){super(),this.nColors=t,this.conditions=e,this.nStates=this.nColors,this.neighbourTypes=i,this.neighbourhoodGeometryType=r,this.periodicityLength=o}updateRule(e,t,i,r){t=0;for(let o=0;o<this.conditions.length;o++)if(this.conditions[o].test(i,e,r)){t=(o+1)%this.nColors;break}return t}getName(){return this.conditions.map((e=>e.name())).join("||")}static sampleRule(t=null,i=null,r=null,o=4,n=4,l=null){var a=[];null==t&&(t=Math.floor(8*Math.random())+2),null==r&&(r=e(c)()),null==l&&(l=this.samplePeriodicityLength());for(let e=0;e<t;e++)a.push(C.randomSample(i,o,r,l));return console.log((new Date).toLocaleTimeString()+" Sampling coloring rule "+r+": "+a.map((e=>e.name())).join(", ")),new M(a,n,i,r,l)}static samplePeriodicityLength(){var e=Math.random();return e<.2?null:e<.6?1:e<.7?2:e<.8?3:e<.9?4:Math.floor(5*Math.random())+5}static ruleFromNames(e,t=4){var i=e.split("||").map((e=>C.fromName(e)));return new M(i,t,null,r,null)}evolveRule(e=null){var t,i=this.conditions.length;null==e&&(e=this.neighbourTypes),0==(t=2==i?Math.floor(2*Math.random())+1:10==i?Math.floor(2*Math.random()):Math.floor(3*Math.random()))?this.removeCondition():1==t?this.changeCondition(e):this.addCondition(e)}addCondition(e){var t=this.conditions.slice();t.push(C.randomSample(e,4,this.neighbourhoodGeometryType,this.periodicityLength)),console.log((new Date).toLocaleTimeString()+" Adding condition "+this.neighbourhoodGeometryType+": "+t.map((e=>e.name())).join("||")),this.conditions=t}removeCondition(){var e=this.conditions.slice(),t=Math.floor(Math.random()*e.length);e.splice(t,1)[0],console.log((new Date).toLocaleTimeString()+" Removing condition: "+e.map((e=>e.name())).join("||")),this.conditions=e}changeCondition(e){var t=this.conditions.slice(),i=Math.floor(Math.random()*t.length);t[i]=C.randomSample(e,4,this.neighbourhoodGeometryType,this.periodicityLength),console.log((new Date).toLocaleTimeString()+" Changing condition "+i+" to "+this.neighbourhoodGeometryType+": "+t.map((e=>e.name())).join("||")),this.conditions=t}}class S extends y{constructor(e,t){super(),this.nColors=t,this.conditions=e,this.nStates=this.nColors}updateRule(e,t,i,r){t=0;var o=this.conditions[e%4];for(let r=0;r<o.length;r++)if(o[r].test(i,e)){t=(r+1)%this.nColors;break}return t}getName(){return this.conditions.map((e=>e.map((e=>e.name())).join(", "))).join(" || ")}static sampleRule(e=null,t=null,i=4,r=4){var o=[];for(let r=0;r<4;r++){o.push([]),null==e&&(e=Math.floor(8*Math.random())+2);for(let n=0;n<e;n++)o[r].push(C.randomSample(t,i))}return console.log("Sampling sparse four state rule: "+o.map((e=>e.map((e=>e.name())).join(", "))).join("||")),new S(o,r)}static ruleFromNames(e,t=4){var i=[],r=e.split(" || ");for(let e=0;e<r.length;e++){i.push([]);var o=r[e].split(", ");i[e]=o.map((e=>C.fromName(e)))}return new S(i,t)}}const w="safe",I="mix",R="general";class E{colorUnit;ruleChain;updateRule;getRuleChain(){throw new Error("Must override method")}getUpdateRule(){return function(e,t,i,r){t=this.ruleChain[0].updateRule(e%this.ruleChain[0].nStates,t,i,r);var o=this.ruleChain[0].nStates;for(let n=1;n<this.ruleChain.length;n++)t+=o*this.ruleChain[n].updateRule(Math.floor(e/o)%this.ruleChain[n].nStates,t,i,r),t%=o*=this.ruleChain[n].nStates;return t%o}}evolveRuleChain(){throw new Error("Must override method")}getName(){return this.ruleChain.map((e=>e.getName())).join("-")}}class H extends E{constructor(e,t,i=null){super(),this.preset=e,this.neighbourTypes=t,this.periodicityLength=null,this.neighbourGeometryType=null,null==t&&(this.neighbourTypes=e==w?{0:1,1:0}:e==I?{0:.8,1:.2}:{0:.5,1:.5}),this.colorUnit=4,this.ruleChain=null==i?this.getRuleChain():this.getRuleChainfromName(i),this.updateRule=this.getUpdateRule()}getRuleChain(){var e=[];return e.push(new b),e.push(M.sampleRule(null,this.neighbourTypes,this.neighbourGeometryType,4,4,this.periodicityLength)),e}evolveRuleChain(){var e=this.neighbourTypes;this.ruleChain[1].evolveRule(e)}getRuleChainfromName(e){var t=[],i=e.split("-")[1];return t.push(new b),t.push(M.ruleFromNames(i)),t}}class P extends E{constructor(e){super(),this.neighbourTypes=e,null==e&&(this.neighbourTypes={0:.5,1:.5}),this.colorUnit=1,this.ruleChain=this.getRuleChain(),this.updateRule=this.getUpdateRule()}getRuleChain(){var e=[];return e.push(S.sampleRule(4,this.neighbourTypes)),e}evolveRuleChain(){}}function W(e,t=!1){Math.random()<Math.exp(e.ruleLogSwitchProbability)||t||e.changeColoringRuleFlag?("VariableGR"==e.rule?(e.ruleClass=new H(w),e.ruleClass2=new H(w)):"Variable"==e.rule?e.ruleClass=new H(w):"VariableMix"==e.rule?e.ruleClass=new H(I):"VariableUnsafe"==e.rule?e.ruleClass=new H(R):"CustomRule"==e.rule?e.ruleClass=new H(null,null,e.tempRuleStorage):"SparseFourStates"==e.rule&&(e.ruleClass=new P),e.ruleLogSwitchProbability=-25,e.ruleLogEvolveProbability=-25,e.changeColoringRuleFlag=!1,k(e)):(Math.random()<Math.exp(e.ruleLogEvolveProbability)||e.evolveColoringRuleFlag)&&"CustomRule"!=e.rule&&(e.ruleClass.evolveRuleChain(),"VariableGR"==e.rule&&e.ruleClass2.evolveRuleChain(),e.ruleLogEvolveProbability=-25,e.evolveColoringRuleFlag=!1,k(e)),e.ruleLogSwitchProbability=e.ruleLogSwitchProbability+e.logMultiplicativeFactor,e.ruleLogSwitchProbability>0&&(e.ruleLogSwitchProbability=0),e.ruleLogEvolveProbability=e.ruleLogEvolveProbability+e.logMultiplicativeEvolveFactor,e.ruleLogEvolveProbability>0&&(e.ruleLogEvolveProbability=0)}function k(e){var t=document.getElementById("currentRule");t&&(t.value=e.ruleClass.getName())}function F(e){let t={};for(let i in e){let r=Math.floor(3*Math.random())-1,o=e[i]+r;o=Math.max(0,Math.min(255,o)),t[i]=o}return t}function B(e){var t={r:247,g:255,b:28},i={r:13,g:112,b:255},r={r:240,g:239,b:239},o={r:0,g:0,b:0},n={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())},l={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())};"yellow"==e.colorPalette?(e.backgroundColor=t,e.activatedColor=o,e.deadColor=i,e.superActivatedColor=r):"blue"==e.colorPalette?(e.backgroundColor=i,e.activatedColor=r,e.deadColor=o,e.superActivatedColor=t):"blue2"==e.colorPalette?(e.backgroundColor=i,e.activatedColor=t,e.deadColor=o,e.superActivatedColor=r):"grey"==e.colorPalette?(e.backgroundColor=r,e.activatedColor=o,e.deadColor=i,e.superActivatedColor=t):"grey2"==e.colorPalette?(e.backgroundColor=r,e.activatedColor=t,e.deadColor=o,e.superActivatedColor=i):"black"==e.colorPalette?(e.backgroundColor=o,e.activatedColor=i,e.deadColor=t,e.superActivatedColor=r):"black2"==e.colorPalette?(e.backgroundColor=o,e.activatedColor=i,e.deadColor=r,e.superActivatedColor=t):"blackTrace"==e.colorPalette?(e.backgroundColor=o,e.activatedColor=r,e.deadColor=o,e.superActivatedColor=r):"blackTrace2"==e.colorPalette?(e.backgroundColor=o,e.activatedColor=o,e.deadColor=o,e.superActivatedColor=r):"blackTrace3"==e.colorPalette?(e.backgroundColor=o,e.activatedColor=o,e.deadColor=r,e.superActivatedColor=r):"variable"==e.colorPalette&&(e.backgroundColor=o,e.activatedColor={r:240,g:240,b:240},e.deadColor=n,e.superActivatedColor=l)}function L(e,t,i,r,o){let n=(t+r+e.gridHeight)%e.gridHeight,l=(i+o+e.gridWidth)%e.gridWidth,a=n,d=l;return(n-t-r>0||n-t-r<0)&&(d=(e.gridWidth-l-e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth),(l-i-o>0||l-i-o<0)&&(a=(e.gridHeight-n-e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight),[a,d]}function X(e,t,i,r,o){let n=(t+r+e.gridHeight)%e.gridHeight,l=(i+o+e.gridWidth)%e.gridWidth,a=n,d=l;return(n-t-r>0||n-t-r<0)&&(d=(e.gridWidth-l-e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth),l-i-o>0?a=(n+e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight:l-i-o<0&&(a=(n-e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight),[a,d]}function Y(e,t,i,r,o){let n=(t+r+e.gridHeight)%e.gridHeight,l=(i+o+e.gridWidth)%e.gridWidth,a=n,d=l;return n-t-r>0?d=(l+e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth:n-t-r<0&&(d=(l-e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth),(l-i-o>0||l-i-o<0)&&(a=(e.gridHeight-n-e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight),[a,d]}function N(e,t,i,r,o){let n=(t+r+e.gridHeight)%e.gridHeight,l=(i+o+e.gridWidth)%e.gridWidth,a=n,d=l;return n-t-r>0?d=(l+e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth:n-t-r<0&&(d=(l-e.gridPeriodicityShiftX+e.gridWidth)%e.gridWidth),l-i-o>0?a=(n+e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight:l-i-o<0&&(a=(n-e.gridPeriodicityShiftY+e.gridHeight)%e.gridHeight),[a,d]}function x(e){e.gridFlipX&&e.gridFlipY?e.findNeighbour=L:e.gridFlipX?e.findNeighbour=X:e.gridFlipY?e.findNeighbour=Y:e.findNeighbour=N}function A(e){W(e,!0)}function T(e,t){if(e.saveEventData){var i={...e.ruleDefinition};delete i.secondaryRule,delete i.conditions;var r={...i,event:t},o=Object.keys(r).join(",")+"\n";o+=Object.values(r).join(",");var n=new Blob([o],{type:"text/csv"}),l=URL.createObjectURL(n),a=document.createElement("a");a.href=l,a.download="dataAutomata.csv",a.click()}}class j{constructor(e,t){this.width=e,this.height=t,this.data=new Uint8Array(e*t),this.rows=new Array(t)}get(e,t){return this.data[e*this.width+t]}set(e,t,i){this.data[e*this.width+t]=i}}let G={shortStar0:{prob:2,mask:[[1,0],[0,1]]},shortStar1:{prob:2,mask:[[0,1],[1,0]]},shortStar2:{prob:2,mask:[[1,0],[0,1]]},waveSquare:{prob:2,mask:[[1,1],[1,1]]},star:{prob:4,mask:[[1,0,1],[0,0,0],[1,0,1]]},oscillator:{prob:4,mask:[[0,0,1,0],[1,2,2,0],[0,2,2,1],[0,1,0,0]]},random2:{prob:30,mask:null}},D=Object.keys(G).map((e=>G[e].mask)),U=e(Object.keys(G).map((e=>G[e].prob)));function V(e,t,i,r,o){for(var n=function(e){var t=Math.exp(-e),i=1,r=0;do{r++,i*=Math.random()}while(i>t);return r-1}(10**e.randomnessAmount),l=0;l<n;l++){t=Math.floor(Math.random()*e.gridHeight),i=Math.floor(Math.random()*e.gridWidth);q(r,e,D[U()],t,i,o)}return{i:t,j:i}}function q(e,t,i,r,o,n){null===i&&(i=function(){let e=Math.floor(10*Math.random())+1,t=Math.floor(10*Math.random())+1,i=[];for(let r=0;r<e;r++){i.push([]);for(let e=0;e<t;e++)i[r].push(Math.floor(4*Math.random()))}return i}());let l=i.length,a=i[0].length;for(let d=0;d<l;d++)for(let s=0;s<a;s++){let h=n(t,r,o,d-Math.floor(l/2),s-Math.floor(a/2));e.set(h[0],h[1],i[d][s])}}function O(e){!function(e){let t=e.ctx,i=e.imageData;for(var r=0,o=0;o<e.gridHeight;o++)for(var n=0;n<e.gridWidth;n++){if(0==e.redraw.get(o,n))continue;r+=1;var l=Math.floor(e.grid.get(o,n)/e.ruleClass.colorUnit)%4;let t;if(0==l)t=e.backgroundColor;else if(1==l)t=e.activatedColor;else if(2==l)t=e.deadColor;else{if(3!=l)continue;t=e.superActivatedColor}let a=4*(o*e.gridWidth+n);i.data[a+0]=t.r,i.data[a+1]=t.g,i.data[a+2]=t.b,i.data[a+3]=255}if(e.nCellChangedHistoric=.01*r+.99*e.nCellChangedHistoric,e.nCellChangedHistoric>.5*e.gridHeight*e.gridWidth){e.changeColoringRuleFlag=!0;var a=e.nCellChangedHistoric/(e.gridHeight*e.gridWidth);console.log("Changing rule because suspected oscillation (running proportion of cells changed: "+a.toFixed(1)+")."),e.nCellChangedHistoric=15,T(e,"oscillation")}e.nCellChangedHistoric<3&&(e.changeColoringRuleFlag=!0,console.log("Changing rule because not enough cells changed ("+e.nCellChangedHistoric+")."),e.nCellChangedHistoric=20,T(e,"blackout")),t.putImageData(i,e.canvasCornerX,e.canvasCornerY)}(e),function(e){for(var r=[new Array(t[0]).fill(0),new Array(t[1]).fill(0)],o=[0,0,0,0,0],n=new j(e.gridWidth,e.gridHeight),l=0;l<e.gridHeight;l++)for(var a=0;a<e.gridWidth;a++){var d=i(e,l,a,r,o);let t=e.grid.get(l,a);var s=t;s="VariableGR"!=e.rule||0==e.mask.get(l,a)?e.ruleClass.updateRule(t,s,d,e.time):e.ruleClass2.updateRule(t,s,d,e.time),Math.floor(s/e.ruleClass.colorUnit)%4!=Math.floor(t/e.ruleClass.colorUnit)%4?e.redraw.set(l,a,1):e.redraw.set(l,a,0),n.set(l,a,s);for(let e=0;e<r.length;e++)r[e].fill(0);o.fill(0)}if(e.addRandomness)var{i:l,j:a}=V(e,l,a,n,e.findNeighbour);e.grid=n}(e),W(e),e.time=(e.time+1)%166320,function(e){Math.random()<1e-4&&(e.gridPeriodicityShiftX=Math.floor(Math.random()*e.gridWidth),console.log("Periodicity shift X: "+e.gridPeriodicityShiftX)),Math.random()<1e-4&&(e.gridPeriodicityShiftY=Math.floor(Math.random()*e.gridHeight),console.log("Periodicity shift Y: "+e.gridPeriodicityShiftY)),Math.random()<1e-4&&(e.gridFlipX=!e.gridFlipX,x(e),console.log("Flip X: "+e.gridFlipX)),Math.random()<1e-4&&(e.gridFlipY=!e.gridFlipY,x(e),console.log("Flip Y: "+e.gridFlipY))}(e),"variable"==e.colorPalette&&function(e){Math.random()<1&&(e.superActivatedColor=F(e.superActivatedColor),e.deadColor=F(e.deadColor))}(e),setTimeout((function(){requestAnimationFrame((()=>O(e)))}),e.timeout)}function K(e,t){return console.log("Attempting to load image"),(i="grLogoLarge.png",console.log("Loading image:",i),new Promise(((e,t)=>{const r=new Image;r.onload=()=>{console.log("Image loaded:",i);const t=document.createElement("canvas");t.width=r.width,t.height=r.height;const o=t.getContext("2d");o.drawImage(r,0,0,r.width,r.height);const n=o.getImageData(0,0,t.width,t.height).data,l=[];for(let e=0;e<r.height;e++){const t=[];for(let i=0;i<r.width;i++){const o=4*(e*r.width+i),l=(n[o]+n[o+1]+n[o+2])/3;t.push(l>128?1:0)}l.push(t)}e(l)},r.onerror=()=>{console.error("Error loading image:",i),t(new Error("Error loading image"))},r.src=i}))).then((t=>{new j(e.gridWidth,e.gridHeight);const i=new j(e.gridWidth,e.gridHeight),r=t[0].length/e.gridWidth,o=t.length/e.gridHeight,n=Math.max(r,o),l=Math.floor((e.gridWidth-t[0].length/n)/2),a=Math.floor((e.gridHeight-t.length/n)/2);for(let r=0;r<e.gridHeight;r++)for(let o=0;o<e.gridWidth;o++){if(r<a||(r-a)*n>=t.length){i.set(r,o,1);continue}let e=Math.floor((o-l)*n);0===t[Math.floor((r-a)*n)][e]?i.set(r,o,0):i.set(r,o,1)}e.mask=i})).catch((t=>{console.log("Image loading failed, not using a mask."),console.error("Error loading image:",t),e.mask=new j(e.gridWidth,e.gridHeight)}));var i}async function $(e,t){return await K(e),function(e,t=64){return Promise.resolve().then((()=>{e.grid=new j(e.gridWidth,e.gridHeight),e.redraw=new j(e.gridWidth,e.gridHeight);for(var i=0;i<e.gridHeight;i++)for(var r=0;r<e.gridWidth;r++)if("gr"!=e.initialisation||1!==e.mask.get(i,r)){for(var o=Math.random(),n=0;n<t;n++)if(o<(n+1)/(t+1)){e.grid.set(i,r,n);break}e.redraw.set(i,r,1)}else e.grid.set(i,r,0)}))}(e)}function z(e){document.getElementById("submitButton").addEventListener("click",(function(){var e,t,i,r,o,n,l,a,d,s,h,g;e=document.getElementById("userGridHeight").value,t=document.getElementById("userGridWidth").value,i=document.getElementById("userTimeout").value,r=document.getElementById("userXShift").value,o=document.getElementById("userYShift").value,n=document.getElementById("userFlipX").checked,l=document.getElementById("userFlipY").checked,a=document.getElementById("userColorPalette").value,d=document.getElementById("randomnessCheckbox").checked,s=document.getElementById("randomnessSlider").value,h=document.getElementById("metaRule").value,g=null,document.getElementById("currentRule")&&(g=document.getElementById("currentRule").value),localStorage.setItem("userGridHeight",e),localStorage.setItem("userGridWidth",t),localStorage.setItem("userTimeout",i),localStorage.setItem("userXShift",r),localStorage.setItem("userYShift",o),localStorage.setItem("userFlipX",n),localStorage.setItem("userFlipY",l),localStorage.setItem("userColorPalette",a),localStorage.setItem("userRandomnessOn",d),localStorage.setItem("userRandomnessAmount",s),localStorage.setItem("metaRule",h),localStorage.setItem("currentRule",g),location.reload()}))}function J(e){document.getElementById("randomnessSlider").addEventListener("input",(function(){!function(e,t){e.randomnessAmount=t,document.getElementById("randomnessAmountValue").textContent=t}(e,this.value)}))}console.log("Loading main.js");var Q=document.getElementById("gameCanvas"),Z=Q.getContext("2d"),_=128,ee=128,te=20,ie=!0,re=-1,oe=0,ne=0,le=!1,ae=!1,de="black2",se="VariableGR",he="random",ge=6,ue=new class{constructor(e,t,i=200,r=200,o=20,n=!0,l=-2,a=0,d=0,s=!1,h=!1,g="black2",u="VariableGR",c="random",m=6,f=2e4,v=2e3){this.gridHeight=i,this.gridWidth=r,this.canvasCornerX=0,this.canvasCornerY=0,this.timeout=o,this.grid=null,this.redraw=null,this.imageData=null,this.canvas=e,this.ctx=t,this.addRandomness=n,this.randomnessAmount=l,this.gridPeriodicityShiftX=a,this.gridPeriodicityShiftY=d,this.gridFlipX=s,this.gridFlipY=h,this.colorPalette=g,this.rule=u,this.initialisation=c,this.maxNColors=m,this.updateCellValue=null,this.updateCellValueAuxiliary=null,this.findNeighbour=null,this.mask=null,this.ruleSwitchPeriod=f,this.ruleEvolvePeriod=v,this.ruleLogSwitchProbability=-25,this.ruleLogEvolveProbability=-25,this.logMultiplicativeFactor=25/this.ruleSwitchPeriod,this.logMultiplicativeEvolveFactor=25/this.ruleEvolvePeriod,this.canvas.width=this.gridWidth,this.canvas.height=this.gridHeight,this.imageData=t.createImageData(e.width,e.height),this.changeColoringRuleFlag=!0,this.evolveColoringRuleFlag=!1,this.nCellChangedHistoric=0,this.saveEventData=!1,this.time=0}}(Q,Z,_,ee,te,ie,re,oe,ne,le,ae,de,se,he,ge);window.onload=function(){!function(e){document.getElementById("randomnessCheckbox").addEventListener("change",(function(){e.addRandomness=this.checked}))}(ue),function(e){document.getElementById("fullscreenButton").addEventListener("click",(function(){e.canvas.requestFullscreen?e.canvas.requestFullscreen():e.canvas.mozRequestFullScreen?e.canvas.mozRequestFullScreen():e.canvas.webkitRequestFullscreen?e.canvas.webkitRequestFullscreen():e.canvas.msRequestFullscreen&&e.canvas.msRequestFullscreen()}))}(ue),function(e){e.canvas.addEventListener("mousemove",(function(t){if(t.shiftKey){var i=e.canvas.getBoundingClientRect(),r=t.clientX-i.left,o=t.clientY-i.top,n=i.width/e.gridWidth,l=i.height/e.gridHeight,a=Math.floor(r/n),d=Math.floor(o/l);e.grid.set(d,a,1)}}))}(ue),function(e){e.canvas.addEventListener("mousedown",(function(t){var i=e.canvas.getBoundingClientRect(),r=t.clientX-i.left,o=t.clientY-i.top,n=i.width/e.gridWidth,l=i.height/e.gridHeight,a=Math.floor(r/n),d=Math.floor(o/l);t.shiftKey||t.ctrlKey?t.shiftKey&&!t.ctrlKey?(e.grid.set(d,(a+1)%e.gridWidth,1),e.grid.set(d,a,1),e.grid.set((d+1)%e.gridHeight,a,1)):!t.shiftKey&&t.ctrlKey?(e.grid.set(d,a,1),e.grid.set((d+1)%e.gridHeight,a,1)):t.shiftKey&&t.ctrlKey&&(e.grid.set(d,a,1),e.grid.set(d,(a+1)%e.gridWidth,1)):(e.grid.set((d+1)%e.gridHeight,(a+1)%e.gridWidth,1),e.grid.set((d-1+e.gridHeight)%e.gridHeight,(a+1)%e.gridWidth,1),e.grid.set((d-1+e.gridHeight)%e.gridHeight,(a-1+e.gridWidth)%e.gridWidth,1),e.grid.set((d+1)%e.gridHeight,(a-1+e.gridWidth)%e.gridWidth,1))}))}(ue),z(),J(ue),function(e){document.getElementById("userXShift").addEventListener("input",(function(){let t=parseInt(this.value);isNaN(t)&&(t=0),e.gridPeriodicityShiftX=t,x(e)})),document.getElementById("userYShift").addEventListener("input",(function(){let t=parseInt(this.value);isNaN(t)&&(t=0),e.gridPeriodicityShiftY=t,x(e)})),document.getElementById("userFlipX").addEventListener("change",(function(){e.gridFlipX=this.checked,x(e)})),document.getElementById("userFlipY").addEventListener("change",(function(){e.gridFlipY=this.checked,x(e)}))}(ue),function(e){document.getElementById("userTimeout").addEventListener("input",(function(){let t=parseInt(this.value);isNaN(t)&&(t=0),e.timeout=t}))}(ue),function(e){document.getElementById("userColorPalette").addEventListener("change",(function(){e.colorPalette=this.value,B(e)}))}(ue),function(e){document.getElementById("metaRule").addEventListener("change",(async function(){e.rule=this.value,A(e)}))}(ue),function(e){document.getElementById("changeColoringRule").addEventListener("click",(function(){e.changeColoringRuleFlag=!0})),document.getElementById("evolveColoringRule").addEventListener("click",(function(){e.evolveColoringRuleFlag=!0}))}(ue),function(e){null!==localStorage.getItem("userGridHeight")?(e.gridHeight=parseInt(localStorage.getItem("userGridHeight")),e.gridWidth=parseInt(localStorage.getItem("userGridWidth")),e.gridHeight>1e3&&(e.gridHeight=1e3),e.gridWidth>1e3&&(e.gridWidth=1e3),e.imageData=e.ctx.createImageData(e.gridWidth,e.gridHeight),e.timeout=parseInt(localStorage.getItem("userTimeout")),e.gridPeriodicityShiftX=parseInt(localStorage.getItem("userXShift")),isNaN(e.gridPeriodicityShiftX)&&(e.gridPeriodicityShiftX=0),isNaN(e.gridPeriodicityShiftY)&&(e.gridPeriodicityShiftY=0),e.gridPeriodicityShiftY=parseInt(localStorage.getItem("userYShift")),e.gridFlipX="true"===localStorage.getItem("userFlipX"),e.gridFlipY="true"===localStorage.getItem("userFlipY"),e.colorPalette=localStorage.getItem("userColorPalette"),e.addRandomness="true"===localStorage.getItem("userRandomnessOn"),e.randomnessAmount=parseFloat(localStorage.getItem("userRandomnessAmount")),e.rule=localStorage.getItem("metaRule"),e.tempRuleStorage=localStorage.getItem("currentRule"),console.log("Retrieved value from previous session: ...")):console.log("No value in localStorage"),document.getElementById("userGridHeight").value=e.gridHeight,document.getElementById("userGridWidth").value=e.gridWidth,document.getElementById("userTimeout").value=e.timeout,document.getElementById("userXShift").value=e.gridPeriodicityShiftX,document.getElementById("userYShift").value=e.gridPeriodicityShiftY,document.getElementById("userFlipX").checked=e.gridFlipX,document.getElementById("userFlipY").checked=e.gridFlipY,document.getElementById("userColorPalette").value=e.colorPalette,document.getElementById("randomnessCheckbox").checked=e.addRandomness,document.getElementById("randomnessSlider").value=e.randomnessAmount,document.getElementById("metaRule").value=e.rule,e.canvas.width=Math.max(e.gridHeight,e.gridWidth),e.canvas.height=Math.max(e.gridHeight,e.gridWidth),e.canvasCornerX=0,e.canvasCornerY=0;var t=document.getElementById("gameCanvas");if(e.gridHeight>e.gridWidth){var i=Math.floor(e.gridWidth/e.gridHeight*800);t.style.width=i+"px",t.style.height="800px",t.width=i*e.gridHeight/800,t.height=e.gridHeight}else{var r=Math.floor(e.gridHeight/e.gridWidth*800);t.style.width="800px",t.style.height=r+"px",t.width=e.gridWidth,t.height=r*e.gridWidth/800}}(ue),B(ue),x(ue),A(ue),$(ue).then((()=>{O(ue)})).catch((e=>{console.error("Error initialising the grid: ",e)}))}})();
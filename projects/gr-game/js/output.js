(()=>{"use strict";function t(t){let e=Object.values(t).reduce(((t,e)=>t+e),0),n=Object.values(t).reduce(((t,n,r)=>[...t,n/e+(t[r-1]||0)]),[]);return function(){let e=Math.random(),r=n.findIndex((t=>e<t));return Object.keys(t)[r]}}const e=[44,44];function n(t,e,n,r,s,i,a){const o=r.height-1,u=r.width-1,h=r.data,l=r.width;for(var c=s[0],m=s[1],f=-1;f<=1;f++)for(var d=-1;d<=1;d++){if(0==f&&0==d)continue;if(i[0]=((-1===f?1:f)+(-1===d?1:d))%2,i[1+(3&a)]=-1==f?1:0,i[1+(1+a&3)]=-1==d?1:0,i[1+(2+a&3)]=1==f?1:0,i[1+(3+a&3)]=1==d?1:0,0==e||0==n||e==o||n==u)var[g,M]=t.t(t,e,n,f,d);else var g=e+f,M=n+d;const r=h[g*l+M],s=3&r,v=(15&r)>>2;if(1==s){c[0]+=1;for(var p=0;p<i.length;p++)c[4+8*p]+=i[p],c[8*(p+1)]+=1-i[p]}else if(2==s){c[2]+=1;for(p=0;p<i.length;p++)c[4+8*p+2]+=i[p],c[8*(p+1)+2]+=1-i[p]}else if(3==s){c[3]+=1;for(p=0;p<i.length;p++)c[4+8*p+3]+=i[p],c[8*(p+1)+3]+=1-i[p]}if(0==v){m[0]+=1;for(p=0;p<i.length;p++)m[4+8*p]+=i[p],m[8*(p+1)]+=1-i[p]}else if(1==v){m[1]+=1;for(p=0;p<i.length;p++)m[4+8*p+1]+=i[p],m[8*(p+1)+1]+=1-i[p]}else if(2==v){m[2]+=1;for(p=0;p<i.length;p++)m[4+8*p+2]+=i[p],m[8*(p+1)+2]+=1-i[p]}else if(3==v){m[3]+=1;for(p=0;p<i.length;p++)m[4+8*p+3]+=i[p],m[8*(p+1)+3]+=1-i[p]}}c[1]=c[0]+c[3];for(p=0;p<i.length+1;p++)c[4*p+1]+=c[4*p]+c[4*p+3];return s}const r="mix",s="isotropic",i="xcross",a="vcross",o="xvcross",u="directional1",h="directional2",l="directional3",c="directional2b",m="directional",f={[r]:.2,[s]:.4,[i]:.05,[a]:.05,[o]:.05,[u]:.05,[h]:.05,[l]:.05,[c]:.05,[m]:.05};const d="A",g="C",M="E",p="B";class v{constructor(t,e,n,r,s,i=null){this.type=t,this.threshold=e,this.i=n,this.o=r,this.u=s,this.h=i,this.l=function(t,e){return t==g?function(t){return 0==t}:t==d?function(t){return t%e==0}:function(t){return!0}}(this.o,this.u),this.m=function(t,e,n){return e==M?function(e){return e[n[0]][n[1]]==t}:e==p?function(e){return e[n[0]][n[1]]>t}:void 0}(this.threshold,this.type,this.i),this.M=function(t){let e;return e=null==t?function(t){return!0}:function(e){return t[e%t.length]},e}(i)}test(t,e,n){var r=this.M(n);return this.m(t)&&this.l(e)&&r}name(){var t="";return null!=this.h&&(t=this.h.map((t=>t?"1":"0")).join("")),`${this.type}${this.threshold}${this.o}[${this.i[0]}|${this.i[1]}]${t}`}static p(t,e=4){var n=null;t.startsWith(M)?n=M:t.startsWith(p)&&(n=p);var r=t.substring(n.length),s=parseInt(r.substring(0,1)),i=null;(r=r.substring(1)).startsWith(g)?i=g:r.startsWith(d)?i=d:r.startsWith("N")&&(i="N");var a=(r=r.substring(i.length)).split("[")[1].split("]")[0].split("|").map(Number),o=null;return(r=r.split("]")[1]).length>0&&(o=r.split("").map((t=>"1"===t))),new v(n,s,a,i,e,o)}static v(e=null,n=4,f=r,b=null){const w=[M,p],S=w[Math.floor(Math.random()*w.length)],k=[g,d,"N"],R=k[Math.floor(Math.random()*k.length)];null===e&&(e={0:2/3,1:1/3});const C=t(e)(),N=function(t,e){var n=e;if(n==r){var f=Math.random();n=f<.5?s:f<.7?i:f<.9?a:m}if(n==s)return Math.floor(4*Math.random());if(n==a)return Math.floor(4*Math.random()+4);if(n==i)return Math.floor(4*Math.random()+8);if(n==o)return Math.floor(8*Math.random()+4);if(n==u)return Math.floor(4*Math.random()+12);if(n==h)return Math.floor(8*Math.random()+12);if(n==l)return Math.floor(12*Math.random()+12);if(n==c){var d=Math.floor(8*Math.random()+12);return d>=16&&(d+=4),d}return n==m?Math.floor(16*Math.random()+12):void 0}(0,f),x=[C,N];var y=0,A=8;if(0==x[0]&&x[1]%4!=1?A=5:x[1]>4&&x[1]<=16?A=4:x[1]>16&&(A=3),y=S===p?Math.floor(Math.random()*A):Math.floor(Math.random()*A)+1,Math.random()<.2)F=null;else{var F;null==b&&(b=Math.floor(20*Math.random())+2);do{F=new Array(b).fill(0).map((()=>Math.random()<.5))}while(!F.includes(!0))}return new v(S,y,x,R,n,F)}}class b{constructor(t,e){this.width=t,this.height=e,this.data=new Uint8Array(this.width*this.height),this.rows=new Array(this.height),this.S=!1,this.get=this.k,this.set=this.R}static C(t,e=!1,n=!1,r=!1){const s=t.length,i=t[0].length,a=new b(i,s);for(let e=0;e<s;e++){r&&(e=s-e-1);for(let r=0;r<i;r++)n&&(r=i-r-1),a.set(e,r,t[e][r])}return e&&a.N(),a}N(){[this.width,this.height]=[this.height,this.width],[this.get,this.set]=this.S?[this.k,this.R]:[this.A,this.F],this.S=!this.S}flipX(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width/2;e++){const n=this.get(t,e);this.set(t,e,this.get(t,this.width-e-1)),this.set(t,this.width-e-1,n)}}flipY(){for(let t=0;t<this.height/2;t++)for(let e=0;e<this.width;e++){const n=this.get(t,e);this.set(t,e,this.get(this.height-t-1,e)),this.set(this.height-t-1,e,n)}}k(t,e){return this.data[t*this.width+e]}R(t,e,n){this.data[t*this.width+e]=n}A(t,e){return this.data[e*this.height+t]}F(t,e,n){this.data[e*this.height+t]=n}}class w{constructor(){this.B=void 0}P(t,e,n,r){throw new Error("Must override method")}G(){throw new Error("Must override method")}}class S extends w{constructor(){super(),this.T=this.X(),this.Y(),this.I=0}X(){throw new Error("Must override method")}Y(){this.O=Object.keys(this.T).map((t=>this.T[t].mask));let e=Object.keys(this.T).map((t=>this.T[t].U));this.V=t(e)}}class k extends S{constructor(){super(),this.B=4}P(t,e,n,r){var s=t%4;return 1==s||3==s?e=2:2==s?e=0:0==s&&2==n[0][0]?e=1:0==s&&n[0][0]>2&&(e=3),e}G(){return"BB"}X(){return{random:{U:10,mask:null},W:{U:2,mask:b.C([[1,0],[0,1]])},j:{U:2,mask:b.C([[0,1],[1,0]])},H:{U:2,mask:b.C([[1,0],[0,1]])},L:{U:4,mask:b.C([[1,1],[1,1]])},$:{U:4,mask:new b([[1,0,1],[0,0,0],[1,0,1]])},D:{U:2,mask:b.C([[0,0,1,0],[1,2,2,0],[0,2,2,1],[0,1,0,0]])},q:{U:2,mask:b.C([[0,0,2,0,0,0,0],[0,1,1,0,0,1,0],[0,0,2,1,2,1,2],[0,0,1,0,1,0,0],[2,1,2,1,2,0,0],[0,1,0,0,1,1,0],[0,0,0,0,2,0,0]])},J:{U:2,mask:b.C([[0,1,2,1,2,1,0],[1,2,0,1,0,2,1],[1,2,0,1,0,2,1],[0,1,2,1,2,1,0]])},K:{U:2,mask:b.C([[0,1,2,1,2,1,0],[1,2,0,1,0,2,1],[1,2,0,1,0,2,1],[0,1,2,1,2,1,0]],!0)}}}}class R extends S{constructor(){super(),this.B=4,this.I=-1}P(t,e,n,r){var s=t%4;return 3==s&&(s=0),1==s?e=2:2==s||3==s?e=0:0!=s&&3!=s||2!=n[0][0]?0==s&&n[0][0]>2&&(e=3):e=1,e}G(){return"TBB"}X(){return{random:{U:10,mask:null},J:{U:1,mask:b.C([[0,1,2,1,2,1,0],[1,2,0,1,0,2,1],[1,2,0,1,0,2,1],[0,1,2,1,2,1,0]])},D:{U:2,mask:b.C([[0,0,1,0],[1,2,2,0],[0,2,2,1],[0,1,0,0]])},q:{U:2,mask:b.C([[0,0,2,0,0,0,0],[0,1,1,0,0,1,0],[0,0,2,1,2,1,2],[0,0,1,0,1,0,0],[2,1,2,1,2,0,0],[0,1,0,0,1,1,0],[0,0,0,0,2,0,0]])},L:{U:4,mask:b.C([[1,1],[1,1]])},Z:{U:1e4,mask:b.C([[0,2,1,0,0,0,0,0],[0,0,2,1,0,0,0,0],[2,0,0,2,1,0,0,0],[1,2,0,0,2,1,0,0],[0,1,0,2,1,0,2,1],[0,0,2,1,0,0,2,1]])}}}}class C extends S{constructor(){super(),this.B=4,this.I=-1}P(t,e,n,r){var s=t%4;return 1==s&&(n[0][0]<3||n[0][0]>5)?e=2:2==s?e=3:3==s?e=0:0==s&&2==n[0][0]&&(e=1),e}G(){return"SW"}X(){let t=.2;return{random:{U:3,mask:null},_:{U:1,mask:b.C([[0,1,2,1,2,1,0],[1,2,0,1,0,2,1],[1,2,0,1,0,2,1],[0,1,2,1,2,1,0]])},tt:{U:t,mask:b.C([[1,2,3],[0,1,0],[1,1,0],[0,1,0],[0,1,0],[1,1,0],[0,1,2],[3,0,1]])},et:{U:t,mask:b.C([[0,0,1,0,0,0,0,0,0],[0,1,1,1,0,0,1,2,0],[3,0,1,0,0,0,1,0,3],[0,0,1,1,0,1,1,1,0],[0,0,1,1,0,0,1,0,0],[0,0,2,0,0,3,2,1,0]])},nt:{U:t,mask:b.C([[0,0,0,1,0,1,0,0],[0,1,2,0,1,1,1,0],[1,2,3,1,1,0,1,1],[1,2,3,0,0,1,1,0],[0,0,0,0,1,2,0,0]])},rt:{U:t,mask:b.C([[0,0,0,0,0,3,2,0],[0,0,1,0,0,1,0,0],[1,1,1,1,1,1,1,1],[0,1,0,0,0,0,1,0],[0,1,0,0,0,0,1,0],[1,1,1,0,0,1,1,1],[0,1,0,0,0,0,1,0]])},st:{U:t,mask:b.C([[0,0,0,1,0,0],[0,0,1,1,1,3],[0,0,0,1,0,2],[0,0,0,0,0,1],[0,1,0,1,1,0],[1,1,1,1,1,1],[0,1,0,0,1,0]])},it:{U:t,mask:b.C([[0,1,1,2,0],[2,0,1,0,3],[3,1,1,1,0],[0,1,0,2,1]])},ot:{U:t,mask:b.C([[0,0,0,2,0],[3,0,1,1,0],[2,1,1,1,3],[1,0,1,0,2],[0,0,0,1,0]])},ut:{U:t,mask:b.C([[0,1,0,0,1,0,0,0,0,0],[1,1,1,2,2,1,0,3,2,0],[0,1,0,2,0,1,0,0,1,0],[0,1,2,2,1,1,1,1,1,1],[0,0,1,0,0,1,0,0,1,0]])},ht:{U:t,mask:b.C([[0,0,0,0,3,2,0,0],[0,0,0,0,1,0,3,0],[0,0,1,2,0,1,0,0],[0,0,2,3,1,1,0,0],[3,1,0,1,0,1,1,1],[2,0,1,1,1,0,1,3],[0,3,0,0,1,1,1,0],[0,0,0,0,1,3,0,0]])},lt:{U:t,mask:b.C([[0,0,0,1,0,3,0,0],[0,0,2,0,1,0,2,1],[0,0,3,1,1,1,2,1],[0,0,1,0,1,0,3,0],[3,0,1,0,1,0,0,0],[2,1,1,1,3,0,0,0],[1,0,1,0,2,0,0,0],[0,0,0,0,1,3,0,0]])},ct:{U:t,mask:b.C([[0,0,1,1,3,0,1,0],[0,1,0,2,2,1,1,1],[1,1,1,0,0,0,1,0],[0,1,0,0,0,0,3,0]])},ft:{U:t,mask:b.C([[0,3,2,1,1,2,3,0],[0,0,1,0,0,1,0,0],[1,1,1,1,1,1,1,1],[2,3,0,0,0,0,3,2]])},dt:{U:t,mask:b.C([[0,2,3,0,0,1,0,0,0],[1,0,1,1,1,1,0,3,0],[0,1,1,0,0,1,1,2,1],[0,0,1,1,1,1,0,2,1],[0,1,2,0,0,0,3,0,0]])},gt:{U:t,mask:b.C([[0,0,0,0,3,0,0,0,0],[0,0,0,0,2,0,0,0,0],[0,0,1,0,1,0,1,0,0],[0,2,3,1,1,1,3,2,0],[1,0,1,0,0,0,1,0,1],[1,1,1,1,0,1,1,1,1],[2,0,1,0,2,0,1,0,2],[0,3,0,1,0,1,0,3,0]])},Mt:{U:t,mask:b.C([[0,0,0,1,0,1,0,0,0],[1,0,1,0,1,0,1,0,1],[2,1,1,1,1,1,1,1,2],[0,1,0,1,0,1,0,1,0],[0,1,0,0,1,0,0,1,0],[1,1,1,1,1,1,1,1,1],[0,1,0,0,1,0,0,1,0]])},vt:{U:t,mask:b.C([[0,1,0,0,0,0],[1,1,1,0,0,0],[0,1,0,0,1,0],[0,0,0,1,1,1],[0,0,0,0,1,0]])},$:{U:2,mask:b.C([[0,0,0,1,0,0,0],[0,0,1,1,1,0,0],[0,1,0,0,0,1,0],[1,1,0,0,0,1,1],[0,1,0,0,0,1,0],[0,0,1,1,1,0,0],[0,0,0,1,0,0,0]])}}}}class N extends S{constructor(t){super(),this.bt=t;const e=this.bt.split("/");this.wt=new Uint8Array(e[0].substring(1).split("").map(Number)),this.St=new Uint8Array(e[1].substring(1).split("").map(Number)),this.B=Number(e[2])}P(t,e,n,r){var s=t%this.B;return 1==s&&this.St.includes(n[0][0])?e=1:s>0&&s<this.B-1?e+=1:s==this.B-1?e=0:0==s&&this.wt.includes(n[0][0])&&(e=1),e}G(){return this.bt}X(){return{random:{U:1,mask:null}}}}class x extends S{constructor(){super(),this.B=4}P(t,e,n,r){var s=n[0][1];return(t%4==1||t%4==3)&&s<2?e=2:t%4!=1&&t%4!=3||2!=s&&3!=s?(t%4==1||t%4==3)&&s>5?e=2:t%4!=0&&t%4!=2||3!=s?t%4==2&&(e=0):e=3:e=1,e}X(){return{kt:{U:1,mask:null}}}G(){return"CW"}}class y extends w{constructor(t,e,n,r,s){super(),this.Rt=e,this.Ct=t,this.B=this.Rt,this.Nt=n,this.xt=r,this.yt=s}P(t,e,n,r){e=0;for(let s=0;s<this.Ct.length;s++)if(this.Ct[s].test(n,t,r)){e=(s+1)%this.Rt;break}return e}G(){return this.Ct.map((t=>t.name())).join("||")}static At(e=null,n=null,r=null,s=4,i=4,a=null){var o=[];null==e&&(e=Math.floor(8*Math.random())+2),null==r&&(r=t(f)()),null==a&&(a=this.Ft());for(let t=0;t<e;t++)o.push(v.v(n,s,r,a));return console.log((new Date).toLocaleTimeString()+" Sampling coloring rule "+r+": "+o.map((t=>t.name())).join(", ")),new y(o,i,n,r,a)}static Ft(){var t=Math.random();return t<.2?null:t<.6?1:t<.7?2:t<.8?3:t<.9?4:Math.floor(20*Math.random())+5}static Bt(t,e=4){var n=t.split("||").map((t=>v.p(t)));return new y(n,e,null,r,null)}Pt(t=null){var e,n=this.Ct.length;null==t&&(t=this.Nt),0==(e=2==n?Math.floor(2*Math.random())+1:10==n?Math.floor(2*Math.random()):Math.floor(3*Math.random()))?this.Gt():1==e?this.Tt(t):this.Xt(t)}Xt(t){var e=this.Ct.slice();e.push(v.v(t,4,this.xt,this.yt)),console.log((new Date).toLocaleTimeString()+" Adding condition "+this.xt+": "+e.map((t=>t.name())).join("||")),this.Ct=e}Gt(){var t=this.Ct.slice(),e=Math.floor(Math.random()*t.length);t.splice(e,1)[0],console.log((new Date).toLocaleTimeString()+" Removing condition: "+t.map((t=>t.name())).join("||")),this.Ct=t}Tt(t){var e=this.Ct.slice(),n=Math.floor(Math.random()*e.length);e[n]=v.v(t,4,this.xt,this.yt),console.log((new Date).toLocaleTimeString()+" Changing condition "+n+" to "+this.xt+": "+e.map((t=>t.name())).join("||")),this.Ct=e}}class A extends w{constructor(t,e){super(),this.Rt=e,this.Ct=t,this.B=this.Rt}P(t,e,n,r){e=0;var s=this.Ct[t%4];for(let r=0;r<s.length;r++)if(s[r].test(n,t)){e=(r+1)%this.Rt;break}return e}G(){return this.Ct.map((t=>t.map((t=>t.name())).join(", "))).join(" || ")}static At(t=null,e=null,n=4,r=4){var s=[];for(let r=0;r<4;r++){s.push([]),null==t&&(t=Math.floor(8*Math.random())+2);for(let i=0;i<t;i++)s[r].push(v.v(e,n))}return console.log("Sampling sparse four state rule: "+s.map((t=>t.map((t=>t.name())).join(", "))).join("||")),new A(s,r)}static Bt(t,e=4){var n=[],r=t.split(" || ");for(let t=0;t<r.length;t++){n.push([]);var s=r[t].split(", ");n[t]=s.map((t=>v.p(t)))}return new A(n,e)}}const F="safe",B="mix",P="general";class G{Yt;It;P;Ot(){throw new Error("Must override method")}Et(){return function(t,e,n,r){e=this.It[0].P(t%this.It[0].B,e,n,r);var s=this.It[0].B;for(let i=1;i<this.It.length;i++)e+=s*this.It[i].P(Math.floor(t/s)%this.It[i].B,e,n,r),e%=s*=this.It[i].B;return e%s}}Ut(){throw new Error("Must override method")}G(){return this.It.map((t=>t.G())).join("-")}}class T extends G{constructor(t){super(),this.Vt=t,this.Yt=1,this.It=this.Ot(),this.P=this.Et()}Ot(){var t=[];return"Original"==this.Vt?t.push(new R):"StarWars"==this.Vt?t.push(new C):"Modified"==this.Vt?t.push(new k):t.push(new N(this.Vt)),t}Ut(){}}class X extends G{constructor(t,e,n=null){super(),this.Vt=t,this.Nt=e,this.yt=null,this.Wt=null,null==e&&(t==F?this.Nt={0:1,1:0}:t==B?(Math.random()<.5?this.Nt={0:.8,1:.2}:this.Nt={0:1,1:0},this.Nt={0:.8,1:.2}):this.Nt={0:.5,1:.5}),this.Yt=4,this.It=null==n?this.Ot():this.jt(n),this.P=this.Et()}Ot(){var t=[];if(this.Vt==F)t.push(new k);else{var e=Math.random();e<.5?t.push(new k):e<.6?t.push(new R):e<.8?t.push(new C):e<.9?t.push(new x):this.Vt,0==t.length&&t.push(new k)}return t.push(y.At(null,this.Nt,this.Wt,4,4,this.yt)),t}Ut(){this.It[1].Pt(this.Nt)}jt(t){var e=[],[n,r]=t.split("-");return"BB"==n?e.push(new k):"TBB"==n?e.push(new R):"SW"==n&&e.push(new C),e.push(new C),e.push(y.Bt(r)),e}}class Y extends G{constructor(t,e,n=null){super(),this.Vt=t,this.Nt=e,this.yt=null,this.Wt=null,null==e&&(t==F?this.Nt={0:1,1:0}:t==B?(Math.random()<.5?this.Nt={0:.8,1:.2}:this.Nt={0:1,1:0},this.Nt={0:.8,1:.2}):this.Nt={0:.5,1:.5}),this.Yt=16,this.It=null==n?this.Ot():this.jt(n),this.P=this.Et()}Ot(){var t=[];return t.push(new k),t.push(y.At(null,this.Nt,this.Wt,4,4,this.h)),t.push(y.At(null,this.Nt,this.Wt,16,4,this.h)),t}Ut(){this.It[1].Pt(this.Nt),this.It[2].Pt(this.Nt)}jt(t){var e=[],n=t.split("-")[1];return e.push(new k),e.push(y.Bt(n)),e}}class I extends G{constructor(t){super(),this.Nt=t,null==t&&(this.Nt={0:.5,1:.5}),this.Yt=1,this.It=this.Ot(),this.P=this.Et()}Ot(){var t=[];return t.push(A.At(4,this.Nt)),t}Ut(){}}function O(t,e=!1){Math.random()<Math.exp(t.Ht)||e||t.Lt?("VariableGR"==t.$t?(t.Dt=new X(F),t.qt=new X(F)):"Variable"==t.$t?t.Dt=new X(F):"VariableMix"==t.$t?t.Dt=new X(B):"VariableUnsafe"==t.$t?t.Dt=new X(P):"Variable2Unsafe"==t.$t?t.Dt=new Y(P):"CustomRule"==t.$t?t.Dt=new X(null,null,t.zt):"OriginalBB"==t.$t?t.Dt=new T("Original"):"ModifiedBB"==t.$t?t.Dt=new T("Modified"):"StarWars"==t.$t?t.Dt=new T("StarWars"):"SparseFourStates"==t.$t&&(t.Dt=new I),t.Ht=-25,t.Jt=-25,t.Lt=!1,E(t)):(Math.random()<Math.exp(t.Jt)||t.Kt)&&"CustomRule"!=t.$t&&(t.Dt.Ut(),"VariableGR"==t.$t&&t.qt.Ut(),t.Jt=-25,t.Kt=!1,E(t)),t.Ht=t.Ht+t.Qt,t.Ht>0&&(t.Ht=0),t.Jt=t.Jt+t.Zt,t.Jt>0&&(t.Jt=0)}function E(t){var e=document.getElementById("currentRule");e&&(e.value=t.Dt.G())}function U(t){let e={};for(let n in t){let r=Math.floor(3*Math.random())-1,s=t[n]+r;s=Math.max(0,Math.min(255,s)),e[n]=s}return e}function V(t){var e={r:247,g:255,b:28},n={r:13,g:112,b:255},r={r:240,g:239,b:239},s={r:0,g:0,b:0},i={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())},a={r:Math.floor(256*Math.random()),g:Math.floor(256*Math.random()),b:Math.floor(256*Math.random())};"yellow"==t._t?(t.backgroundColor=e,t.te=s,t.ee=n,t.ne=r):"blue"==t._t?(t.backgroundColor=n,t.te=r,t.ee=s,t.ne=e):"blue2"==t._t?(t.backgroundColor=n,t.te=e,t.ee=s,t.ne=r):"grey"==t._t?(t.backgroundColor=r,t.te=s,t.ee=n,t.ne=e):"grey2"==t._t?(t.backgroundColor=r,t.te=e,t.ee=s,t.ne=n):"black"==t._t?(t.backgroundColor=s,t.te=n,t.ee=e,t.ne=r):"black2"==t._t?(t.backgroundColor=s,t.te=n,t.ee=r,t.ne=e):"blackTrace"==t._t?(t.backgroundColor=s,t.te=r,t.ee=s,t.ne=r):"blackTrace2"==t._t?(t.backgroundColor=s,t.te=s,t.ee=s,t.ne=r):"blackTrace3"==t._t?(t.backgroundColor=s,t.te=s,t.ee=r,t.ne=r):"variable"==t._t&&(t.backgroundColor=s,t.te={r:240,g:240,b:240},t.ee=i,t.ne=a)}function W(t,e,n,r,s){let i=(e+r+t.re)%t.re,a=(n+s+t.se)%t.se,o=i,u=a;return(i-e-r>0||i-e-r<0)&&(u=(t.se-a-t.ie+t.se)%t.se),(a-n-s>0||a-n-s<0)&&(o=(t.re-i-t.ae+t.re)%t.re),[o,u]}function j(t,e,n,r,s){let i=(e+r+t.re)%t.re,a=(n+s+t.se)%t.se,o=i,u=a;return(i-e-r>0||i-e-r<0)&&(u=(t.se-a-t.ie+t.se)%t.se),a-n-s>0?o=(i+t.ae+t.re)%t.re:a-n-s<0&&(o=(i-t.ae+t.re)%t.re),[o,u]}function H(t,e,n,r,s){let i=(e+r+t.re)%t.re,a=(n+s+t.se)%t.se,o=i,u=a;return i-e-r>0?u=(a+t.ie+t.se)%t.se:i-e-r<0&&(u=(a-t.ie+t.se)%t.se),(a-n-s>0||a-n-s<0)&&(o=(t.re-i-t.ae+t.re)%t.re),[o,u]}function L(t,e,n,r,s){let i=(e+r+t.re)%t.re,a=(n+s+t.se)%t.se,o=i,u=a;return i-e-r>0?u=(a+t.ie+t.se)%t.se:i-e-r<0&&(u=(a-t.ie+t.se)%t.se),a-n-s>0?o=(i+t.ae+t.re)%t.re:a-n-s<0&&(o=(i-t.ae+t.re)%t.re),[o,u]}function $(t){t.oe&&t.ue?t.t=W:t.oe?t.t=j:t.ue?t.t=H:t.t=L}function D(t){O(t,!0)}function q(t,e){if(t.he){var n={...t.le};delete n.ce,delete n.Ct;var r={...n,event:e},s=Object.keys(r).join(",")+"\n";s+=Object.values(r).join(",");var i=new Blob([s],{type:"text/csv"}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download="dataAutomata.csv",o.click()}}function z(t,e,n){for(var r=function(t){var e=Math.exp(-t),n=1,r=0;do{r++,n*=Math.random()}while(n>e);return r-1}(10**(t.me+t.Dt.It[0].I)),s=t.Dt.It[0].V,i=t.Dt.It[0].O,a=0;a<r;a++){var o=Math.floor(Math.random()*t.re),u=Math.floor(Math.random()*t.se);J(e,t,i[s()],o,u,n)}}function J(t,e,n,r,s,i){null===n?n=function(){let t=Math.floor(10*Math.random())+1,e=Math.floor(10*Math.random())+1,n=new b(e,t);for(let r=0;r<t;r++)for(let t=0;t<e;t++)n.set(r,t,Math.floor(4*Math.random()));return n}():(Math.random()<.5&&n.N(),Math.random()<.5&&n.flipX(),Math.random()<.5&&n.flipY());let a=n.height,o=n.width;for(let u=0;u<a;u++)for(let h=0;h<o;h++){let l=i(e,r,s,u-Math.floor(a/2),h-Math.floor(o/2));t.set(l[0],l[1],n.get(u,h))}}function K(t){!function(t){let e=t.fe,n=t.de;for(var r=0,s=0;s<t.re;s++)for(var i=0;i<t.se;i++){if(0==t.ge.get(s,i))continue;r+=1;var a=Math.floor(t.grid.get(s,i)/t.Dt.Yt)%4;let e;if(0==a)e=t.backgroundColor;else if(1==a)e=t.te;else if(2==a)e=t.ee;else{if(3!=a)continue;e=t.ne}let o=4*(s*t.se+i);n.data[o+0]=e.r,n.data[o+1]=e.g,n.data[o+2]=e.b,n.data[o+3]=255}if(t.Me=.01*r+.99*t.Me,t.Me>.5*t.re*t.se){t.Lt=!0;var o=t.Me/(t.re*t.se);console.log("Changing rule because suspected oscillation (running proportion of cells changed: "+o.toFixed(1)+")."),t.Me=15,q(t,"oscillation")}t.Me<3&&(t.Lt=!0,console.log("Changing rule because not enough cells changed ("+t.Me+")."),t.Me=20,q(t,"blackout")),e.putImageData(n,t.pe,t.ve)}(t),function(t){var r=[new Uint8Array(e[0]).fill(0),new Uint8Array(e[1]).fill(0)],s=new Uint8Array(5).fill(0),i=new b(t.se,t.re),a=t.grid;const o=t.time;for(var u=0;u<t.re;u++)for(var h=0;h<t.se;h++){var l=n(t,u,h,a,r,s,o);const e=t.grid.get(u,h);var c=e;c="VariableGR"!=t.$t||0==t.mask.get(u,h)?t.Dt.P(e,c,l,t.time):t.qt.P(e,c,l,t.time),Math.floor(c/t.Dt.Yt)%4!=Math.floor(e/t.Dt.Yt)%4?t.ge.set(u,h,1):t.ge.set(u,h,0),i.set(u,h,c);for(let t=0;t<r.length;t++)r[t].fill(0);s.fill(0)}t.be&&z(t,i,t.t),t.grid=i}(t),O(t),t.time=(t.time+1)%166320,function(t){Math.random()<1e-4&&(t.ie=Math.floor(Math.random()*t.se),console.log("Periodicity shift X: "+t.ie)),Math.random()<1e-4&&(t.ae=Math.floor(Math.random()*t.re),console.log("Periodicity shift Y: "+t.ae)),Math.random()<1e-4&&(t.oe=!t.oe,$(t),console.log("Flip X: "+t.oe)),Math.random()<1e-4&&(t.ue=!t.ue,$(t),console.log("Flip Y: "+t.ue))}(t),"variable"==t._t&&function(t){Math.random()<1&&(t.ne=U(t.ne),t.ee=U(t.ee))}(t),setTimeout((function(){requestAnimationFrame((()=>K(t)))}),t.timeout)}function Q(t,e){return console.log("Attempting to load image"),(n="grLogoLarge.png",console.log("Loading image:",n),new Promise(((t,e)=>{const r=new Image;r.onload=()=>{console.log("Image loaded:",n);const e=document.createElement("canvas");e.width=r.width,e.height=r.height;const s=e.getContext("2d");s.drawImage(r,0,0,r.width,r.height);const i=s.getImageData(0,0,e.width,e.height).data,a=[];for(let t=0;t<r.height;t++){const e=[];for(let n=0;n<r.width;n++){const s=4*(t*r.width+n),a=(i[s]+i[s+1]+i[s+2])/3;e.push(a>128?1:0)}a.push(e)}t(a)},r.onerror=()=>{console.error("Error loading image:",n),e(new Error("Error loading image"))},r.src=n}))).then((e=>{new b(t.se,t.re);const n=new b(t.se,t.re),r=e[0].length/t.se,s=e.length/t.re,i=Math.max(r,s),a=Math.floor((t.se-e[0].length/i)/2),o=Math.floor((t.re-e.length/i)/2);for(let r=0;r<t.re;r++)for(let s=0;s<t.se;s++){if(r<o||(r-o)*i>=e.length){n.set(r,s,1);continue}let t=Math.floor((s-a)*i);0===e[Math.floor((r-o)*i)][t]?n.set(r,s,0):n.set(r,s,1)}t.mask=n})).catch((e=>{console.log("Image loading failed, not using a mask."),console.error("Error loading image:",e),t.mask=new b(t.se,t.re)}));var n}async function Z(t,e){return await Q(t),function(t,e=64){return Promise.resolve().then((()=>{t.grid=new b(t.se,t.re),t.ge=new b(t.se,t.re);for(var n=0;n<t.re;n++)for(var r=0;r<t.se;r++)if("gr"!=t.we||1!==t.mask.get(n,r)){for(var s=Math.random(),i=0;i<e;i++)if(s<(i+1)/(e+1)){t.grid.set(n,r,i);break}t.ge.set(n,r,1)}else t.grid.set(n,r,0)}))}(t)}function _(t){document.getElementById("submitButton").addEventListener("click",(function(){var t,e,n,r,s,i,a,o,u,h,l,c;t=document.getElementById("userGridHeight").value,e=document.getElementById("userGridWidth").value,n=document.getElementById("userTimeout").value,r=document.getElementById("userXShift").value,s=document.getElementById("userYShift").value,i=document.getElementById("userFlipX").checked,a=document.getElementById("userFlipY").checked,o=document.getElementById("userColorPalette").value,u=document.getElementById("randomnessCheckbox").checked,h=document.getElementById("randomnessSlider").value,l=document.getElementById("metaRule").value,c=null,document.getElementById("currentRule")&&(c=document.getElementById("currentRule").value),localStorage.setItem("userGridHeight",t),localStorage.setItem("userGridWidth",e),localStorage.setItem("userTimeout",n),localStorage.setItem("userXShift",r),localStorage.setItem("userYShift",s),localStorage.setItem("userFlipX",i),localStorage.setItem("userFlipY",a),localStorage.setItem("userColorPalette",o),localStorage.setItem("userRandomnessOn",u),localStorage.setItem("userRandomnessAmount",h),localStorage.setItem("metaRule",l),localStorage.setItem("currentRule",c),location.reload()}))}function tt(t){document.getElementById("randomnessSlider").addEventListener("input",(function(){!function(t,e){t.me=e,document.getElementById("randomnessAmountValue").textContent=e}(t,this.value)}))}console.log("Loading main.js");var et=document.getElementById("gameCanvas"),nt=et.getContext("2d"),rt=128,st=128,it=20,at=!0,ot=-1,ut=0,ht=0,lt=!1,ct=!1,mt="black2",ft="VariableGR",dt="random",gt=6,Mt=new class{constructor(t,e,n=200,r=200,s=20,i=!0,a=-2,o=0,u=0,h=!1,l=!1,c="black2",m="VariableGR",f="random",d=6,g=2e4,M=2e3){this.re=n,this.se=r,this.pe=0,this.ve=0,this.timeout=s,this.grid=null,this.ge=null,this.de=null,this.canvas=t,this.fe=e,this.be=i,this.me=a,this.ie=o,this.ae=u,this.oe=h,this.ue=l,this._t=c,this.$t=m,this.we=f,this.Se=d,this.ke=null,this.Re=null,this.t=null,this.mask=null,this.Ce=g,this.Ne=M,this.Ht=-25,this.Jt=-25,this.Qt=25/this.Ce,this.Zt=25/this.Ne,this.canvas.width=this.se,this.canvas.height=this.re,this.de=e.createImageData(t.width,t.height),this.Lt=!0,this.Kt=!1,this.Me=0,this.he=!1,this.time=0}}(et,nt,rt,st,it,at,ot,ut,ht,lt,ct,mt,ft,dt,gt);window.onload=function(){!function(t){document.getElementById("randomnessCheckbox").addEventListener("change",(function(){t.be=this.checked}))}(Mt),function(t){document.getElementById("fullscreenButton").addEventListener("click",(function(){t.canvas.requestFullscreen?t.canvas.requestFullscreen():t.canvas.mozRequestFullScreen?t.canvas.mozRequestFullScreen():t.canvas.webkitRequestFullscreen?t.canvas.webkitRequestFullscreen():t.canvas.msRequestFullscreen&&t.canvas.msRequestFullscreen()}))}(Mt),function(t){t.canvas.addEventListener("mousemove",(function(e){if(e.shiftKey){var n=t.canvas.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top,i=n.width/t.se,a=n.height/t.re,o=Math.floor(r/i),u=Math.floor(s/a);t.grid.set(u,o,1)}}))}(Mt),function(t){t.canvas.addEventListener("mousedown",(function(e){var n=t.canvas.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top,i=n.width/t.se,a=n.height/t.re,o=Math.floor(r/i),u=Math.floor(s/a);e.shiftKey||e.ctrlKey?e.shiftKey&&!e.ctrlKey?(t.grid.set(u,(o+1)%t.se,1),t.grid.set(u,o,1),t.grid.set((u+1)%t.re,o,1)):!e.shiftKey&&e.ctrlKey?(t.grid.set(u,o,1),t.grid.set((u+1)%t.re,o,1)):e.shiftKey&&e.ctrlKey&&(t.grid.set(u,o,1),t.grid.set(u,(o+1)%t.se,1)):(t.grid.set((u+1)%t.re,(o+1)%t.se,1),t.grid.set((u-1+t.re)%t.re,(o+1)%t.se,1),t.grid.set((u-1+t.re)%t.re,(o-1+t.se)%t.se,1),t.grid.set((u+1)%t.re,(o-1+t.se)%t.se,1))}))}(Mt),_(),tt(Mt),function(t){document.getElementById("userXShift").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.ie=e,$(t)})),document.getElementById("userYShift").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.ae=e,$(t)})),document.getElementById("userFlipX").addEventListener("change",(function(){t.oe=this.checked,$(t)})),document.getElementById("userFlipY").addEventListener("change",(function(){t.ue=this.checked,$(t)}))}(Mt),function(t){document.getElementById("userTimeout").addEventListener("input",(function(){let e=parseInt(this.value);isNaN(e)&&(e=0),t.timeout=e}))}(Mt),function(t){document.getElementById("userColorPalette").addEventListener("change",(function(){t._t=this.value,V(t)}))}(Mt),function(t){document.getElementById("metaRule").addEventListener("change",(async function(){t.$t=this.value,D(t)}))}(Mt),function(t){document.getElementById("changeColoringRule").addEventListener("click",(function(){t.Lt=!0})),document.getElementById("evolveColoringRule").addEventListener("click",(function(){t.Kt=!0}))}(Mt),function(t){null!==localStorage.getItem("userGridHeight")?(t.re=parseInt(localStorage.getItem("userGridHeight")),t.se=parseInt(localStorage.getItem("userGridWidth")),t.re>1e3&&(t.re=1e3),t.se>1e3&&(t.se=1e3),t.de=t.fe.createImageData(t.se,t.re),t.timeout=parseInt(localStorage.getItem("userTimeout")),t.ie=parseInt(localStorage.getItem("userXShift")),isNaN(t.ie)&&(t.ie=0),isNaN(t.ae)&&(t.ae=0),t.ae=parseInt(localStorage.getItem("userYShift")),t.oe="true"===localStorage.getItem("userFlipX"),t.ue="true"===localStorage.getItem("userFlipY"),t._t=localStorage.getItem("userColorPalette"),t.be="true"===localStorage.getItem("userRandomnessOn"),t.me=parseFloat(localStorage.getItem("userRandomnessAmount")),t.$t=localStorage.getItem("metaRule"),t.zt=localStorage.getItem("currentRule"),console.log("Retrieved value from previous session: ...")):console.log("No value in localStorage"),document.getElementById("userGridHeight").value=t.re,document.getElementById("userGridWidth").value=t.se,document.getElementById("userTimeout").value=t.timeout,document.getElementById("userXShift").value=t.ie,document.getElementById("userYShift").value=t.ae,document.getElementById("userFlipX").checked=t.oe,document.getElementById("userFlipY").checked=t.ue,document.getElementById("userColorPalette").value=t._t,document.getElementById("randomnessCheckbox").checked=t.be,document.getElementById("randomnessSlider").value=t.me,document.getElementById("metaRule").value=t.$t,t.canvas.width=Math.max(t.re,t.se),t.canvas.height=Math.max(t.re,t.se),t.pe=0,t.ve=0;var e=document.getElementById("gameCanvas");if(t.re>t.se){var n=Math.floor(t.se/t.re*800);e.style.width=n+"px",e.style.height="800px",e.width=n*t.re/800,e.height=t.re}else{var r=Math.floor(t.re/t.se*800);e.style.width="800px",e.style.height=r+"px",e.width=t.se,e.height=r*t.se/800}}(Mt),V(Mt),$(Mt),D(Mt),Z(Mt).then((()=>{K(Mt)})).catch((t=>{console.error("Error initialising the grid: ",t)}))}})();